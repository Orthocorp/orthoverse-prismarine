function safeRequire (path) {
  try {
    return require(path)
  } catch (e) {
    return {}
  }
}
const { loadImage } = safeRequire('node-canvas-webgl/lib')
const THREE = require('three')
const path = require('path')

const textureCache = {}

function loadTexture (texture, cb) {
  console.log("Entered utils.js")
  if (textureCache[texture]) {
    cb(textureCache[texture])
  } else {
    // we have either a path or a base64 string
    console.log("Texture is " + texture)
    if (texture.substring(0,2) === '0x') {
      console.log("Trying to set a player skin")
      console.log(path.resolve(__dirname, '../../public/' + texture))
      loadImage('http://localhost:8911/skin').then(image => {
        textureCache[texture] = new THREE.CanvasTexture(image)
        cb(textureCache[texture])
      })
    } else {
      console.log("Trying to set a non-player skin")     
      loadImage(path.resolve(__dirname, '../../public/' + texture)).then(image => {
        textureCache[texture] = new THREE.CanvasTexture(image)
        cb(textureCache[texture])
      })
    }
  }
}

function loadJSON (json, cb) {
  cb(require(path.resolve(__dirname, '../../public/' + json)))
}

module.exports = { loadTexture, loadJSON }
